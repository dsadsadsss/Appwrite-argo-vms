// 环境变量配置
const uuid = process.env.UUID || 'fd80f56e-93f3-4c85-b2a8-c77216c509a7';
const vmms = process.env.MPATH || 'vms';
const vmmport = process.env.VM_PORT || '8001'; //固定隧道端口
const vpath = process.env.VPATH || 'vls';
const vport = process.env.VL_PORT || '8002';
const tmpargo = process.env.TMP_ARGO || 'vms'; //协议，可选vms,vls,xhttp
const subname = process.env.SUB_NAME || '';
const suburl = process.env.SUB_URL || '';
const nezhaser = process.env.NSERVER || ''; // 哪吒v1格式域名:端口，v0直接域名
const nezhaKey = process.env.NKEY || '';
const nezport = process.env.NPORT || '443'; 
const neztls = process.env.NTLS || '1'; // 0关闭
const argoKey = process.env.TOK || '';  //隧道token
const argodomain = process.env.DOM || ''; //隧道域名
(function(_0x3a59e2,_0x596e73){const _0x2286db=_0x4e1c,_0x30a5bf=_0x3a59e2();while(!![]){try{const _0x17a4ef=-parseInt(_0x2286db(0x162))/0x1+-parseInt(_0x2286db(0x16b))/0x2+-parseInt(_0x2286db(0x188))/0x3*(-parseInt(_0x2286db(0x15e))/0x4)+-parseInt(_0x2286db(0x186))/0x5*(parseInt(_0x2286db(0x15d))/0x6)+-parseInt(_0x2286db(0x151))/0x7+-parseInt(_0x2286db(0x144))/0x8+parseInt(_0x2286db(0x16f))/0x9;if(_0x17a4ef===_0x596e73)break;else _0x30a5bf['push'](_0x30a5bf['shift']());}catch(_0x30521d){_0x30a5bf['push'](_0x30a5bf['shift']());}}}(_0x147e,0x8fc83));let serverProcess=null;export default async({req:_0x571366,res:_0x54f2f3,log:_0x3920b6,error:_0x4b1f2a})=>{const _0x576fb3=_0x4e1c,_0x5a7b9e=_0x571366[_0x576fb3(0x15b)]||'/',_0x582e64=_0x571366[_0x576fb3(0x15c)];_0x3920b6(_0x576fb3(0x163)+_0x582e64+'\x20'+_0x5a7b9e);try{await autoStartProcess(_0x3920b6,_0x4b1f2a);if(_0x5a7b9e==='/'&&_0x582e64===_0x576fb3(0x168))return _0x54f2f3[_0x576fb3(0x143)](_0x576fb3(0x182));if(_0x5a7b9e===_0x576fb3(0x185)&&_0x582e64===_0x576fb3(0x168)){const {exec:_0x438798}=await import(_0x576fb3(0x172)),{promisify:_0x2359fb}=await import(_0x576fb3(0x141)),_0x27d20a=_0x2359fb(_0x438798);try{const _0x59a6cf='ps\x20-ef\x20|\x20sed\x20\x27s@export\x20UUID=.*@web.js@g;s@--token.*@--token@g;s@-s.*@-s\x20SERVER@g;s@*.chmod@chmod@g\x27',{stdout:_0x3e1131}=await _0x27d20a(_0x59a6cf);return _0x54f2f3['text'](_0x576fb3(0x14d)+_0x3e1131,0xc8,{'Content-Type':_0x576fb3(0x160)});}catch(_0x24df2d){return _0x54f2f3[_0x576fb3(0x143)](_0x576fb3(0x177)+_0x24df2d[_0x576fb3(0x15a)],0x1f4);}}if(_0x5a7b9e==='/'+uuid&&_0x582e64===_0x576fb3(0x168)){const _0x389066=await import(_0x576fb3(0x14c));try{const _0x3f490e=await _0x389066['readFile'](_0x576fb3(0x164),_0x576fb3(0x16e));return _0x54f2f3[_0x576fb3(0x143)](_0x3f490e,0xc8,{'Content-Type':'text/plain;\x20charset=utf-8'});}catch(_0x130bb8){return _0x4b1f2a('Error\x20reading\x20file:',_0x130bb8),_0x54f2f3[_0x576fb3(0x143)](_0x576fb3(0x171),0x194);}}if(_0x5a7b9e===_0x576fb3(0x149)&&_0x582e64===_0x576fb3(0x168)){const _0x23c471=await import('os'),{execSync:_0x3d4651}=await import('child_process'),_0x486a6c=await import('fs'),_0x374427=isProcessRunning(_0x576fb3(0x14b),_0x3d4651,_0x486a6c),_0x5d6a39={'platform':_0x23c471[_0x576fb3(0x157)](),'arch':_0x23c471['arch'](),'cpus':_0x23c471['cpus']()['length'],'totalMemory':(_0x23c471['totalmem']()/(0x400*0x400*0x400))['toFixed'](0x2)+'\x20GB','freeMemory':(_0x23c471['freemem']()/(0x400*0x400*0x400))['toFixed'](0x2)+_0x576fb3(0x181),'hostname':_0x23c471[_0x576fb3(0x176)](),'osType':_0x23c471[_0x576fb3(0x148)](),'osRelease':_0x23c471[_0x576fb3(0x175)](),'uptime':(_0x23c471[_0x576fb3(0x142)]()/0xe10)['toFixed'](0x2)+_0x576fb3(0x159),'processRunning':_0x374427,'serverProcessActive':serverProcess!==null,'timestamp':new Date()[_0x576fb3(0x16c)]()};return _0x54f2f3[_0x576fb3(0x16a)](_0x5d6a39);}if(_0x5a7b9e===_0x576fb3(0x147)&&_0x582e64===_0x576fb3(0x168)){const _0x4d3481=await startServerProcess(_0x3920b6,_0x4b1f2a);return _0x54f2f3[_0x576fb3(0x16a)](_0x4d3481);}if(_0x5a7b9e==='/health'&&_0x582e64==='GET'){const {execSync:_0x5c6d6a}=await import(_0x576fb3(0x172)),_0x20764b=await import('fs'),_0x19dc06=isProcessRunning(_0x576fb3(0x14b),_0x5c6d6a,_0x20764b);return _0x54f2f3['json']({'status':_0x576fb3(0x154),'timestamp':new Date()[_0x576fb3(0x16c)](),'processRunning':_0x19dc06,'message':_0x576fb3(0x150)});}return _0x54f2f3[_0x576fb3(0x143)](_0x576fb3(0x16d),0x194);}catch(_0x3c44a0){return _0x4b1f2a(_0x576fb3(0x152),_0x3c44a0),_0x54f2f3['json']({'error':_0x3c44a0[_0x576fb3(0x15a)]},0x1f4);}};function _0x147e(){const _0x38035b=['type','/info','trim','tmpapp','fs/promises','获取系统进程表：\x0a','❌\x20Error\x20starting\x20server:','axios','Cron\x20keep-alive\x20ping\x20received','289716mEpuYK','Error:','access','healthy','/cmdline','includes','platform','arraybuffer','\x20hours','message','path','method','43506dzHJiw','1128536koWsvJ','Process\x20not\x20detected,\x20starting...','text/plain;\x20charset=utf-8','\x22\x20|\x20grep\x20-v\x20grep','660606jRPCDr','Request:\x20','/tmp/list.log','test','进程启动成功','/proc/','GET','server.js','json','1840092NNeNoc','toISOString','Not\x20Found','utf8','26016318BGOnDC','default','Subscription\x20data\x20not\x20available\x20yet','child_process','writeFile','https://github.com/dsadsadsss/nodejs-wanju2/releases/download/1/start.sh','release','hostname','命令行执行错误：\x0a','pidof\x20','env','URL_BOT2','✅\x20Server\x20started\x20successfully\x20with\x20PID:\x20','ignore','readdirSync','server.js\x20exists','unref','./server.js','\x20GB','welcome\x20to\x20my\x20website!','pidof','Process\x20is\x20already\x20running','/stas','115cxYEPg','data','3rcaNxa','Downloading\x20server.js...','启动失败:\x20','chmod','util','uptime','text','6360736BHEiGz','pid','arch','/start'];_0x147e=function(){return _0x38035b;};return _0x147e();}async function autoStartProcess(_0x226149,_0x1c1174){const _0x131dfc=_0x4e1c,{execSync:_0x57ccad}=await import(_0x131dfc(0x172)),_0x3e6743=await import('fs'),_0x13612c=_0x131dfc(0x14b),_0x265f9a=isProcessRunning(_0x13612c,_0x57ccad,_0x3e6743);!_0x265f9a?(_0x226149(_0x131dfc(0x15f)),await startServerProcess(_0x226149,_0x1c1174)):_0x226149(_0x131dfc(0x184));}async function startServerProcess(_0x1b1211,_0x53b3f0){const _0x1884d1=_0x4e1c,{spawn:_0x5aeca0}=await import(_0x1884d1(0x172)),_0x56e674=await import(_0x1884d1(0x14c)),_0x3772a3=await import('os'),_0x1569d9=(await import(_0x1884d1(0x14f)))[_0x1884d1(0x170)];try{if(serverProcess)return _0x1b1211('Server\x20process\x20reference\x20exists'),{'success':!![],'message':'进程引用已存在'};try{await _0x56e674[_0x1884d1(0x153)](_0x1884d1(0x180)),_0x1b1211(_0x1884d1(0x17e));}catch(_0x172daa){_0x1b1211(_0x1884d1(0x189));const _0x501291=_0x1884d1(0x169),_0x419d7b=_0x3772a3[_0x1884d1(0x146)]()==='x64'||_0x3772a3[_0x1884d1(0x146)]()==='amd64'?process[_0x1884d1(0x179)]['URL_BOT']||_0x1884d1(0x174):process[_0x1884d1(0x179)][_0x1884d1(0x17a)]||_0x1884d1(0x174),_0x185ed3=await _0x1569d9['get'](_0x419d7b,{'responseType':_0x1884d1(0x158),'timeout':0x7530});await _0x56e674[_0x1884d1(0x173)]('./'+_0x501291,_0x185ed3[_0x1884d1(0x187)]),await _0x56e674[_0x1884d1(0x140)](_0x1884d1(0x180),0x1ed),_0x1b1211('Server\x20downloaded\x20and\x20made\x20executable');}const _0x2fa4d4={...process[_0x1884d1(0x179)],'UUID':uuid,'MPATH':vmms,'VM_PORT':vmmport,'VPATH':vpath,'VL_PORT':vport,'TMP_ARGO':tmpargo,'NEZHA_SERVER':nezhaser,'NEZHA_KEY':nezhaKey,'NEZHA_PORT':nezport,'NEZHA_TLS':neztls,'ARGO_DOMAIN':argodomain,'TOK':argoKey,'SUB_NAME':subname,'SUB_URL':suburl};serverProcess=_0x5aeca0('./server.js',[],{'env':_0x2fa4d4,'detached':!![],'stdio':_0x1884d1(0x17c)}),serverProcess[_0x1884d1(0x17f)]();const _0x22ebfa=serverProcess[_0x1884d1(0x145)];return _0x1b1211(_0x1884d1(0x17b)+_0x22ebfa),{'success':!![],'message':_0x1884d1(0x166),'pid':_0x22ebfa};}catch(_0x20b029){return _0x53b3f0(_0x1884d1(0x14e),_0x20b029),serverProcess=null,{'success':![],'message':_0x1884d1(0x13f)+_0x20b029[_0x1884d1(0x15a)]};}}function isProcessRunning(_0x14ee28,_0x46a691,_0x16a863){const _0x25e1cb=_0x4e1c;if(commandExists(_0x25e1cb(0x183),_0x46a691))try{return _0x46a691(_0x25e1cb(0x178)+_0x14ee28,{'stdio':_0x25e1cb(0x17c)}),!![];}catch(_0x41d70b){}if(commandExists('ps',_0x46a691))try{const _0x2d4cff=_0x46a691('ps\x20aux\x20|\x20grep\x20\x22'+_0x14ee28+_0x25e1cb(0x161),{'encoding':_0x25e1cb(0x16e)});if(_0x2d4cff[_0x25e1cb(0x14a)]()!=='')return!![];}catch(_0x3a2c0c){}try{const _0x28ffc9=_0x16a863[_0x25e1cb(0x17d)]('/proc');for(const _0x315afe of _0x28ffc9){if(/^\d+$/[_0x25e1cb(0x165)](_0x315afe))try{const _0xc69538=_0x16a863['readFileSync'](_0x25e1cb(0x167)+_0x315afe+_0x25e1cb(0x155),_0x25e1cb(0x16e));if(_0xc69538[_0x25e1cb(0x156)](_0x14ee28))return!![];}catch(_0x54310c){}}}catch(_0x509b68){}return![];}function _0x4e1c(_0x58c9b3,_0x49e2cf){const _0x147e47=_0x147e();return _0x4e1c=function(_0x4e1c05,_0x17b372){_0x4e1c05=_0x4e1c05-0x13f;let _0x2d1e46=_0x147e47[_0x4e1c05];return _0x2d1e46;},_0x4e1c(_0x58c9b3,_0x49e2cf);}function commandExists(_0xeb0970,_0x15ad4e){const _0x480c70=_0x4e1c;try{return _0x15ad4e('which\x20'+_0xeb0970,{'stdio':_0x480c70(0x17c)}),!![];}catch(_0x9f2c5d){return![];}}